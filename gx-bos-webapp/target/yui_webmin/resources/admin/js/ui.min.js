function FileProgress(c,d){this.fileProgressID=c.id;this.file=c;this.opacity=100;this.height=0;this.fileProgressWrapper=$("#"+this.fileProgressID);if(!this.fileProgressWrapper.length){this.fileProgressWrapper=$("<tr></tr>");var m=this.fileProgressWrapper;m.attr("id",this.fileProgressID).addClass("progressContainer");var f=$("<td/>");f.addClass("progressName").text(c.name);var e=plupload.formatSize(c.size).toUpperCase();var g=$("<td/>");g.addClass("progressFileSize").text(e);var k=$("<td/>");var b=$("<div/>");b.addClass("info");var a=$("<div/>");a.addClass("progress progress-striped");var h=$("<div/>");h.addClass("progress-bar progress-bar-info").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%");var i=$("<span class=sr-only />");i.text(e);var j=$("<a href=javascript:; />");j.show().addClass("progressCancel").text("×");h.append(i);a.append(h);b.append(a);b.append(j);var l=$('<div class="status text-center"/>');b.append(l);k.append(b);m.append(f);m.append(g);m.append(k);$("#"+d).append(m)}else{this.reset()}this.height=this.fileProgressWrapper.offset().top;this.setTimer(null)}FileProgress.prototype.setTimer=function(a){this.fileProgressWrapper.FP_TIMER=a};FileProgress.prototype.getTimer=function(a){return this.fileProgressWrapper.FP_TIMER||null};FileProgress.prototype.reset=function(){this.fileProgressWrapper.attr("class","progressContainer");this.fileProgressWrapper.find("td .progress .progress-bar-info").attr("aria-valuenow",0).width("0%").find("span").text("");this.appear()};FileProgress.prototype.setChunkProgess=function(j){var k=Math.ceil(this.file.size/j);if(k===1){return false}var c=$('<button class="btn btn-default">查看分块上传进度</button>');var f=$('<tr class="chunk-status-tr"><td colspan=3></td></tr>');var g=$("<div/>");for(var d=1;d<=k;d++){var b=$('<div class="col-md-2"/>');var a=$('<div class="progress progress-striped"></div');var e=$("<div/>");e.addClass("progress-bar progress-bar-info text-left").attr("role","progressbar").attr("aria-valuemax",100).attr("aria-valuenow",0).attr("aria-valuein",0).width("0%").attr("id",this.file.id+"_"+d).text("");var h=$("<span/>");h.addClass("chunk-status").text();a.append(e);a.append(h);b.append(a);g.append(b)}if(!this.fileProgressWrapper.find("td:eq(2) .btn-default").length){this.fileProgressWrapper.find("td>div").append(c)}f.hide().find("td").append(g);f.insertAfter(this.fileProgressWrapper)};FileProgress.prototype.setProgress=function(p,e,o){this.fileProgressWrapper.attr("class","progressContainer green");var f=this.file;var b=f.loaded;var q=plupload.formatSize(b).toUpperCase();var l=plupload.formatSize(e).toUpperCase();var h=this.fileProgressWrapper.find("td .progress").find(".progress-bar-info");if(this.fileProgressWrapper.find(".status").text()==="取消上传"){return}this.fileProgressWrapper.find(".status").text("已上传: "+q+" 上传速度： "+l+"/s");p=parseInt(p,10);if(f.status!==plupload.DONE&&p===100){p=99}h.attr("aria-valuenow",p).css("width",p+"%");if(o){var n=Math.ceil(f.size/o);if(n===1){return false}var d=Math.ceil(b/o);var k,m;for(var i=0;i<d;i++){k=$("#"+f.id+"_"+i);k.width("100%").removeClass().addClass("alert-success").attr("aria-valuenow",100);m="块"+i+"上传进度100%";k.next().html(m)}var g=$("#"+f.id+"_"+d);var j;if(d<n){if(b%o){j=((b%o)/o*100).toFixed(2)}else{j=100;g.removeClass().addClass("alert-success")}}else{var c=f.size-o*(n-1);var a=f.size-b;if(a%c){j=((b%o)/c*100).toFixed(2)}else{j=100;g.removeClass().addClass("alert-success")}}g.width(j+"%");g.attr("aria-valuenow",j);m="块"+d+"上传进度"+j+"%";g.next().html(m)}this.appear()};FileProgress.prototype.setComplete=function(k,o){var h=this.fileProgressWrapper.find("td:eq(2)"),j=h.find(".progress");var p=$.parseJSON(o);var c;if(p.url){c=p.url;str="<div><strong>Link:</strong><a href="+p.url+" target='_blank' > "+p.url+"</a></div><div class=hash><strong>Hash:</strong>"+p.hash+"</div>"}else{var r=k.getOption("domain");c=r+encodeURI(p.key);var e=r+p.key;str="<div><strong>Link:</strong><a href="+c+" target='_blank' > "+e+"</a></div><div class=hash><strong>Hash:</strong>"+p.hash+"</div>"}j.html(str).removeClass().next().next(".status").hide();h.find(".progressCancel").hide();var g=this.fileProgressWrapper.find(".progressName");var f="?imageView2/1/w/100/h/100";var m=function(u){var w,x="";var s=["png","jpg","jpeg","gif","bmp"];var y=/\.([a-zA-Z0-9]+)(\?|\@|$)/;if(!u||!y.test(u)){return false}w=y.exec(u);x=w[1].toLowerCase();for(var v=0,t=s.length;v<t;v++){if(x===s[v]){return true}}return false};var b=m(c);var n=$('<div class="Wrapper"/>');var l=$('<div class="imgWrapper col-md-3"/>');var i=$('<a class="linkWrapper" target="_blank"/>');var d=$('<img src="images/loading.gif"/>');g.append(n);if(!b){d.attr("src","images/default.png");n.addClass("default");l.append(d);n.append(l)}else{i.append(d);l.append(i);n.append(l);var q=new Image();if(!/imageView/.test(c)){c+=f}$(q).attr("src",c);var a=340;$(q).on("load",function(){d.attr("src",c);i.attr("href",c).attr("title","查看原图");function x(D,E,B){$("#myModal-img").modal();var C=$("#myModal-img").find(".modal-body");if(B<=300){$("#myModal-img").find(".text-warning").show()}var F=new Image();C.find("img").attr("src","images/loading.gif");F.onload=function(){C.find("img").attr("src",D).data("key",E).data("h",B);C.find(".modal-body-wrapper").find("a").attr("href",D)};F.src=D}var v=$('<div class="infoWrapper col-md-6"></div>');var w=$('<a class="fopLink"/>');w.attr("data-key",p.key).text("查看处理效果");v.append(w);w.on("click",function(){var D=$(this).data("key");var B=parseInt($(this).parents(".Wrapper").find(".origin-height").text(),10);if(B>$(window).height()-a){B=parseInt($(window).height()-a,10)}else{B=parseInt(B,10)||300}var E=[];E.push({fop:"imageView2",mode:3,h:B,q:100,format:"png"});E.push({fop:"watermark",mode:1,image:"http://www.b1.qiniudn.com/images/logo-2.png",dissolve:100,gravity:"SouthEast",dx:100,dy:100});var C=Qiniu.pipeline(E,D);$("#myModal-img").on("hide.bs.modal",function(){$("#myModal-img").find(".btn-default").removeClass("disabled");$("#myModal-img").find(".text-warning").hide()}).on("show.bs.modal",function(){$("#myModal-img").find(".imageView").find("a:eq(0)").addClass("disabled");$("#myModal-img").find(".watermark").find("a:eq(3)").addClass("disabled");$("#myModal-img").find(".text-warning").hide()});x(C,D,B);return false});var t=Qiniu.detectIEVersion();if(!(t&&t<=9)){var y=Qiniu.exif(p.key);if(y){var u=$('<a href="" target="_blank">查看exif</a>');u.attr("href",c+"?exif");v.append(u)}var A=Qiniu.imageInfo(p.key);var s=$("<div/>");var z='<div>格式：<span class="origin-format">'+A.format+'</span></div><div>宽度：<span class="orgin-width">'+A.width+'px</span></div><div>高度：<span class="origin-height">'+A.height+"px</span></div>";s.html(z);v.append(s)}n.append(v)}).on("error",function(){d.attr("src","default.png");n.addClass("default")})}};FileProgress.prototype.setError=function(){this.fileProgressWrapper.find("td:eq(2)").attr("class","text-warning");this.fileProgressWrapper.find("td:eq(2) .progress").css("width",0).hide();this.fileProgressWrapper.find("button").hide();this.fileProgressWrapper.next(".chunk-status-tr").hide()};FileProgress.prototype.setCancelled=function(b){var a="progressContainer";if(!b){a+=" red"}this.fileProgressWrapper.attr("class",a);this.fileProgressWrapper.find("td .progress").remove();this.fileProgressWrapper.find("td:eq(2) .btn-default").hide();this.fileProgressWrapper.find("td:eq(2) .progressCancel").hide()};FileProgress.prototype.setStatus=function(b,a){if(!a){this.fileProgressWrapper.find(".status").text(b).attr("class","status text-left")}};FileProgress.prototype.bindUploadCancel=function(a){var b=this;if(a){b.fileProgressWrapper.find("td:eq(2) .progressCancel").on("click",function(){b.setCancelled(false);b.setStatus("取消上传");b.fileProgressWrapper.find(".status").css("left","0");a.removeFile(b.file)})}};FileProgress.prototype.appear=function(){if(this.getTimer()!==null){clearTimeout(this.getTimer());this.setTimer(null)}if(this.fileProgressWrapper[0].filters){try{this.fileProgressWrapper[0].filters.item("DXImageTransform.Microsoft.Alpha").opacity=100}catch(a){this.fileProgressWrapper.css("filter","progid:DXImageTransform.Microsoft.Alpha(opacity=100)")}}else{this.fileProgressWrapper.css("opacity",1)}this.fileProgressWrapper.css("height","");this.height=this.fileProgressWrapper.offset().top;this.opacity=100;this.fileProgressWrapper.show()};
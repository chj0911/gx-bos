var closeCreateUserRule=function(){var K=$("#relationType").val();if(K=="plan"){$("#create-user-rule-form").attr("action",base+"/admin/studycenter/plan/createUserRule")}if(K=="train"){$("#rulePlanId").val($("#relationId").val());$("#create-user-rule-form").attr("action",base+"/admin/signUp/train/createUserRule")}if(K=="honor"){$("#rulePlanId").val($("#relationId").val());$("#create-user-rule-form").attr("action",base+"/admin/pcbackground/honorroll/createUserRule")}if(K=="exam"){$("#rulePlanId").val($("#relationId").val());$("#create-user-rule-form").attr("action",base+"/admin/exam/examInfo/createUserRule")}if(K=="category"){$("#rulePlanId").val($("#relationId").val());$("#create-user-rule-form").attr("action",base+"/admin/infocenter/category/createUserRule")}if(K=="survey"){$("#rulePlanId").val($("#relationId").val());$("#create-user-rule-form").attr("action",base+"/admin/survey/type/createUserRule")}if(K=="share"){$("#rulePlanId").val($("#relationId").val());$("#create-user-rule-form").attr("action",base+"/admin/coursecenter/coursemanager/createUserRule")}var p=$("#relationId").val(),z=$("#relationType").val(),b=$("#relationParentTableId").val();var D=$(this),o="",e="",q="",g="",h="",d="",H="",t="",E="",j="";var C=$("#jstree_rule_roles").jstree().get_checked(true);var k=$("#jstree_rule_groups").jstree().get_checked(true);var n=$("#jstree_rule_orgs").jstree().get_checked(true);var r=$("#jstree_rule_posts").jstree().get_checked(true);var A=$("#jstree_rule_office_titles").jstree().get_checked(true);var F=$("#jstree_rule_ranks").jstree().get_checked(true);var c=$("#jstree_rule_branchs").jstree().get_checked(true);var a=$("#jstree_rule_stores").jstree().get_checked(true);var m=$("input[name=userTypeEln]:checked");var u=false,f=false;if(C&&C.length>0){for(var I=0;I<C.length;I++){if(I==0&&I==C.length-1){o="("+o+'roleCodes.contains("'+C[I].data.code+'"))'}else{if(I==0&&I!=C.length-1){o="("+o+'roleCodes.contains("'+C[I].data.code+'")'}else{if(I==C.length-1){o=o+'||roleCodes.contains("'+C[I].data.code+'"))'}else{o=o+'||roleCodes.contains("'+C[I].data.code+'")'}}}}}if(k&&k.length>0){for(var I=0;I<k.length;I++){if(I==0&&I==k.length-1){g="("+g+'userGroupIds.contains("'+k[I].data.id+'"))'}else{if(I==0&&I!=k.length-1){g="("+g+'userGroupIds.contains("'+k[I].data.id+'")'}else{if(I==k.length-1){g=g+'||userGroupIds.contains("'+k[I].data.id+'"))'}else{g=g+'||userGroupIds.contains("'+k[I].data.id+'")'}}}}}if(m&&m.length>0){var B="",y="",x="",w="";for(var I=0;I<m.length;I++){var s=$(m[I]).val();if(s==1||s==2){u=true;if(s==1){B='userType.equals("'+s+'")'}else{y='userType.equals("'+s+'")'}}else{if(s==3||s==4){f=true;if(s==3){x='userType.equals("'+s+'")'}else{w='userType.equals("'+s+'")'}}}}if(B.length>0&&y.length>0){H="("+B+"||"+y+")"}else{if(B.length>0){H="("+B+")"}else{if(y.length>0){H="("+y+")"}}}if(x.length>0&&w.length>0){t="("+x+"||"+w+")"}else{if(x.length>0){t="("+x+")"}else{if(w.length>0){t="("+w+")"}}}}if(A&&u&&A.length>0){for(var I=0;I<A.length;I++){if(I==0&&I==A.length-1){j="("+j+'officeTitle.equals("'+A[I].id+'"))'}else{if(I==0&&I!=A.length-1){j="("+j+'officeTitle.equals("'+A[I].id+'")'}else{if(I==A.length-1){j=j+'||officeTitle.equals("'+A[I].id+'"))'}else{j=j+'||officeTitle.equals("'+A[I].id+'")'}}}}}if(r&&u&&r.length>0){for(var I=0;I<r.length;I++){if(I==0&&I==r.length-1){h="("+h+'post.equals("'+r[I].id+'"))'}else{if(I==0&&I!=r.length-1){h="("+h+'post.equals("'+r[I].id+'")'}else{if(I==r.length-1){h=h+'||post.equals("'+r[I].id+'"))'}else{h=h+'||post.equals("'+r[I].id+'")'}}}}}if(F&&f&&F.length>0){for(var I=0;I<F.length;I++){if(I==0&&I==F.length-1){d="("+d+'level.equals("'+F[I].id+'"))'}else{if(I==0&&I!=F.length-1){d="("+d+'level.equals("'+F[I].id+'")'}else{if(I==F.length-1){d=d+'||level.equals("'+F[I].id+'"))'}else{d=d+'||level.equals("'+F[I].id+'")'}}}}}if(c&&f&&c.length>0){for(var I=0;I<c.length;I++){if(I==0&&I==c.length-1){q="("+q+'dealerOrg.equals("'+c[I].id+'"))'}else{if(I==0&&I!=c.length-1){q="("+q+'dealerOrg.equals("'+c[I].id+'")'}else{if(I==c.length-1){q=q+'||dealerOrg.equals("'+c[I].id+'"))'}else{q=q+'||dealerOrg.equals("'+c[I].id+'")'}}}}}if(n&&u&&n.length>0){for(var I=0;I<n.length;I++){if(I==0&&I==n.length-1){e="("+e+'org.equals("'+n[I].data.code+'"))'}else{if(I==0&&I!=n.length-1){e="("+e+'org.equals("'+n[I].data.code+'")'}else{if(I==n.length-1){e=e+'||org.equals("'+n[I].data.code+'"))'}else{e=e+'||org.equals("'+n[I].data.code+'")'}}}}}if(a&&f&&a.length>0){for(var I=0;I<a.length;I++){if(I==0&&I==a.length-1){E="("+E+'storeType.equals("'+a[I].id+'"))'}else{if(I==0&&I!=a.length-1){E="("+E+'storeType.equals("'+a[I].id+'")'}else{if(I==a.length-1){E=E+'||storeType.equals("'+a[I].id+'"))'}else{E=E+'||storeType.equals("'+a[I].id+'")'}}}}}var J="";var G="",l="";if(H&&H.length>0){if(G&&G.length>0){G=G+"&&"+H}else{G=G+H}}if(t&&t.length>0){if(l&&l.length>0){l=l+"&&"+t}else{l=l+t}}if(o&&o.length>0){if(J&&J.length>0){J=J+"&&"+o}else{J=J+o}}if(g&&g.length>0){if(J&&J.length>0){J=J+"&&"+g}else{J=J+g}}if(e&&e.length>0){if(G&&G.length>0){G=G+"&&"+e}else{G=G+e}}if(h&&h.length>0){if(G&&G.length>0){G=G+"&&"+h}else{G=G+h}}if(j&&j.length>0){if(G&&G.length>0){G=G+"&&"+j}else{G=G+j}}if(q&&q.length>0){if(l&&l.length>0){l=l+"&&"+q}else{l=l+q}}if(d&&d.length>0){if(l&&l.length>0){l=l+"&&"+d}else{l=l+d}}if(E&&E.length>0){if(l&&l.length>0){l=l+"&&"+E}else{l=l+E}}if(G.length>0&&l.length>0){J=J+"&&(("+G+")||("+l+"))"}else{if(G.length>0){J=J+"&&("+G+")"}else{if(l.length>0){J=J+"&&("+l+")"}}}if(J==""||J.length==0){MessageBox.info("请选择关联资源");return}else{$("#expText").val(J)}if(J==""||J.length==0){MessageBox.info("请选择关联资源");return}else{$("#expText").val(J)}var v=$("#create-user-rule-form").valid();if(!v){return}$("#create-user-rule-form").ajaxValidSubmit({success:function(O){MessageBox.success("保存成功");$("#createUserRule").modal("hide");if(b){if(K=="survey"){var N=O.returnObject;var M=$("#createdSurvey_userRuleIds").val();if(M&&M.length){M+=","+N}else{M=N}$("#createdSurvey_userRuleIds").val(M);var L=$("#"+b).attr("data-ajax-url");var i=L.split("?");if(i.length>1){L=i[0]+"?ids="+M}$("#"+b).DataTable().ajax.url(L).load();$("#div-"+b).show()}else{$("#"+b).DataTable().ajax.reload();$("#div-"+b).show()}}},error:function(i){if("数据绑定出错"==i.exceptionMessage){ModalBox.alert(i.validateErrors[0].element+"数据绑定"+i.validateErrors[0].message)}else{ModalBox.alert(i.exceptionMessage)}}})};$(function(){formInitFunc("create-user-rule-form");$('input[name="rule.code"]').bind("myCheck",function(){var a=base+"/admin/usercenter/rule/checkRuleCode?value="+$('input[name="rule.code"]').val()+"&id="+$('input[name="rule.id"]').val();$.ajax({type:"post",url:a,async:false,success:function(b){if(!b.success){$('input[name="rule.code"]').attr("isRepeat",0)}else{$('input[name="rule.code"]').attr("isRepeat",1)}}})});$("#userTypeEln1").click(function(){if($("#userTypeEln1")[0].checked||$("#userTypeEln2")[0].checked){$("#org_div1").show();$("#post_rule_div").show();$("#title_rule_div").show()}else{$("#org_div1").hide();$("#post_rule_div").hide();$("#title_rule_div").hide()}});$("#userTypeEln2").click(function(){if($("#userTypeEln1")[0].checked||$("#userTypeEln2")[0].checked){$("#org_div1").show();$("#post_rule_div").show();$("#title_rule_div").show()}else{$("#org_div1").hide();$("#post_rule_div").hide();$("#title_rule_div").hide()}});$("#userTypeEln3").click(function(){if($("#userTypeEln3")[0].checked||$("#userTypeEln4")[0].checked){$("#org_div2").show();$("#rank_div").show();$("#store_div").show()}else{$("#org_div2").hide();$("#rank_div").hide();$("#store_div").hide()}});$("#userTypeEln4").click(function(){if($("#userTypeEln3")[0].checked||$("#userTypeEln4")[0].checked){$("#org_div2").show();$("#rank_div").show();$("#store_div").show()}else{$("#org_div2").hide();$("#rank_div").hide();$("#store_div").hide()}});$("#createUserRule").on("show.bs.modal",function(){$("#resetRule").click();$("#org_div1").hide();$("#post_rule_div").hide();$("#org_div2").hide();$("#rank_div").hide();$("#store_div").hide();var h=[],a=[],d=[],g=[],b=[],c=[],e=[],f=[];$('input[name="rule.code"]').bind("myCheck",function(){var i=base+"/admin/usercenter/rule/checkRuleCode?value="+$('input[name="rule.code"]').val()+"&id="+$('input[name="rule.id"]').val();$.ajax({type:"post",url:i,async:false,success:function(j){if(!j.success){$('input[name="rule.code"]').attr("isRepeat",0)}else{$('input[name="rule.code"]').attr("isRepeat",1)}}})});$.getJSON(base+"/admin/usercenter/rule/findResources",function(j){var l=j.returnObject;if(l.roles){for(var k=0;k<l.roles.length;k++){h.push({id:l.roles[k].id,text:l.roles[k].name,data:l.roles[k],parent:(l.roles[k].parentId?l.roles[k].parentId:"#")})}}if(l.groups){for(var k=0;k<l.groups.length;k++){g.push({id:l.groups[k].id,text:l.groups[k].name,data:l.groups[k],parent:(l.groups[k].parentId?l.groups[k].parentId:"#")})}}if(l.orgs){for(var k=0;k<l.orgs.length;k++){d.push({id:l.orgs[k].id,text:l.orgs[k].name,data:l.orgs[k],parent:(l.orgs[k].parentId?l.orgs[k].parentId:"#")})}}if(l.regions){for(var k=0;k<l.regions.length;k++){c.push({id:l.regions[k].regionNo,text:l.regions[k].regionDesc,data:l.regions[k],parent:"#"})}if(l.branches){for(var k=0;k<l.branches.length;k++){c.push({id:l.branches[k].branchNo,text:l.branches[k].branchDesc,data:l.branches[k],parent:(l.branches[k].regionNo?l.branches[k].regionNo:"#")})}}}if(l.posts){a.push({id:"all",text:"全部",state:{disabled:true},parent:"#"});for(var k=0;k<l.posts.length;k++){a.push({id:l.posts[k].code,text:l.posts[k].label,parent:"all"})}}if(l.levels){b.push({id:"all",text:"全部",state:{disabled:true},parent:"#"});for(var k=0;k<l.levels.length;k++){b.push({id:l.levels[k].code,text:l.levels[k].label,parent:"all"})}}if(l.officeTitles){f.push({id:"all",text:"全部",state:{disabled:true},parent:"#"});for(var k=0;k<l.officeTitles.length;k++){f.push({id:l.officeTitles[k].code,text:l.officeTitles[k].label,parent:"all"})}}e.push({id:0,text:"全部",state:{disabled:true},parent:"#"});e.push({id:1,text:"专卖店",parent:0});e.push({id:4,text:"可订货工作室",parent:0});e.push({id:5,text:"不可订货工作室",parent:0});$("#jstree_rule_roles").jstree({core:{data:h},checkbox:{keep_selected_style:false},plugins:["wholerow","checkbox"]}).bind("select_node.jstree",function(p,q){$("#jstree_rule_roles").jstree("open_node","#"+q.node.id);var m=q.node.children_d;for(var n=0,o=m.length;n<o;n++){$("#jstree_rule_roles").jstree("open_node","#"+m[n])}}).bind("deselect_node.jstree",function(q,p){$("#jstree_rule_roles").jstree("close_node","#"+p.node.id);var m=p.node.children_d;for(var n=0,o=m.length;n<o;n++){$("#jstree_rule_roles").jstree("close_node","#"+m[n])}});$("#jstree_rule_groups").jstree({core:{data:g},checkbox:{keep_selected_style:false},plugins:["wholerow","checkbox"]}).bind("select_node.jstree",function(p,q){$("#jstree_rule_groups").jstree("open_node","#"+q.node.id);var m=q.node.children_d;for(var n=0,o=m.length;n<o;n++){$("#jstree_rule_groups").jstree("open_node","#"+m[n])}}).bind("deselect_node.jstree",function(q,p){$("#jstree_rule_groups").jstree("close_node","#"+p.node.id);var m=p.node.children_d;for(var n=0,o=m.length;n<o;n++){$("#jstree_rule_groups").jstree("close_node","#"+m[n])}});$("#jstree_rule_posts").jstree({core:{data:a},checkbox:{keep_selected_style:false},plugins:["wholerow","checkbox"]}).bind("select_node.jstree",function(p,q){$("#jstree_rule_posts").jstree("open_node","#"+q.node.id);var m=q.node.children_d;for(var n=0,o=m.length;n<o;n++){$("#jstree_rule_posts").jstree("open_node","#"+m[n])}}).bind("deselect_node.jstree",function(q,p){$("#jstree_rule_posts").jstree("close_node","#"+p.node.id);var m=p.node.children_d;for(var n=0,o=m.length;n<o;n++){$("#jstree_rule_posts").jstree("close_node","#"+m[n])}});$("#jstree_rule_orgs").jstree({core:{data:d},checkbox:{keep_selected_style:false},plugins:["wholerow","checkbox"]}).bind("select_node.jstree",function(p,q){$("#jstree_rule_orgs").jstree("open_node","#"+q.node.id);var m=q.node.children_d;for(var n=0,o=m.length;n<o;n++){$("#jstree_rule_orgs").jstree("open_node","#"+m[n])}}).bind("deselect_node.jstree",function(q,p){$("#jstree_rule_orgs").jstree("close_node","#"+p.node.id);var m=p.node.children_d;for(var n=0,o=m.length;n<o;n++){$("#jstree_rule_orgs").jstree("close_node","#"+m[n])}});$("#jstree_rule_branchs").jstree({core:{data:c},checkbox:{keep_selected_style:false},plugins:["wholerow","checkbox"]}).bind("select_node.jstree",function(p,q){$("#jstree_rule_branchs").jstree("open_node","#"+q.node.id);var m=q.node.children_d;for(var n=0,o=m.length;n<o;n++){$("#jstree_rule_branchs").jstree("open_node","#"+m[n])}}).bind("deselect_node.jstree",function(q,p){$("#jstree_rule_branchs").jstree("close_node","#"+p.node.id);var m=p.node.children_d;for(var n=0,o=m.length;n<o;n++){$("#jstree_rule_branchs").jstree("close_node","#"+m[n])}});$("#jstree_rule_ranks").jstree({core:{data:b},checkbox:{keep_selected_style:true,three_state:false},plugins:["wholerow","checkbox"]});$("#jstree_rule_office_titles").jstree({core:{data:f},checkbox:{keep_selected_style:true,three_state:false},plugins:["wholerow","checkbox"]});$("#jstree_rule_stores").jstree({core:{data:e},checkbox:{keep_selected_style:true,three_state:false},plugins:["wholerow","checkbox"]})})})});
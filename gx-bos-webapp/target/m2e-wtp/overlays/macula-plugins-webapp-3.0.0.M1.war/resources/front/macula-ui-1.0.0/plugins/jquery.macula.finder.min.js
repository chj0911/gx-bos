(function(c,e){var d=[],b=100;function a(f,g){d=c.grep(d,function(k,j){var h=c("#finder-header-"+k).size();if(!h){f.unbind("."+k)}return h>0});f.unbind("."+g);d.push(g)}c.maculafinder=function(h,s){var i={data_send_event:h+"_data_send_."+h,data_arrive_event:h+"_data_arrive_."+h,row_selected_event:h+"_row_selected_."+h,row_choiced_event:h+"_row_choiced_."+h,row_all_selected_event:h+"_rowall_selected_."+h,row_all_unselected_event:h+"_rowall_unselected_."+h,tip_update_event:h+"_tip_update_."+h,item_detail_event:h+"_item_detail_."+h,selected_class:"selected",selected_all_class:"selectedall",unselected_class:"unselected"};var q={refreshTabViews:false,selectedItems:[],selectedAllFlag:false,dataTotal:0};var o=s.relativePath||"";var n=c.extend({code:h,tab:"_",currentPage:1,url:o+"macula-mda/finder/"+h+"/_",tabs:o+"macula-mda/finder/"+h+"/tabs",detail:o+"macula-mda/finder/"+h+"/detail",queryOnLoad:true},s||{});var g=function(v,u){if(v.indexOf("://")>=0){return v}if(v.charAt(0)!="/"){v="/"+v}var t=(u||base);return v.startWith(t)?v:t+v};var k={};c(["packet","action","action-form","search","filter","tip","header","footer","pager","keywords","filter-action","data-tmpl","list","nodata"]).each(function(){k[this]=c("#finder-"+this+"-"+h)});if(k.packet.exists()){n.url=k.packet.find("li.current").attr("url");n.tab=k.packet.find("li.current").attr("tabViewCode")}if(k.action.exists()){k.action.find(".finder-action-group").hover(function(){c(this).find("ul").showme()},function(){c(this).find("ul").hideme()}).click(function(t){return false});k.action.find(".finderAction").click(function(E){var u=c(this),F=c(this).attr("target"),t=g(c(this).attr("submit"),c(this).getContextPath()),H=c(this).attr("confirm"),y=c(this).attr("minRowSelected"),B=c(this).attr("maxRowSelected"),x=c(this).attr("beforeUpdate");var D=k["action-form"].find(">div").empty();if(y>0&&((q.selectedAllFlag&&q.dataTotal<y)||(!q.selectedAllFlag&&q.selectedItems.length<y))){alert("请至少选择 "+y+" 条数据项进行该操作！");return false}if(B>0&&((q.selectedAllFlag&&q.dataTotal>B)||(!q.selectedAllFlag&&q.selectedItems.length>B))){alert("请至多选择 "+B+" 条数据项进行该操作！");return false}if(H&&!window.confirm(H)){return false}if(x&&c.isFunction(window[beforUpdate])){if(window[beforUpdate]()===false){return}}if(n.form){n.form.find("*[name^=filters]:not([disabled])").each(function(){D.append('<input type="hidden" name="selection.'+c(this).attr("name")+'" value="'+c(this).val()+'" />')})}if(!q.selectedAllFlag){for(var A=0;A<q.selectedItems.length;A++){D.append('<input type="hidden" name="selection.items['+A+']" value="'+q.selectedItems[A]+'" />')}}D.append('<input type="hidden" name="selection.selectedAll" value="'+q.selectedAllFlag+'" />');k["action-form"].find('input[name="selection.finderCode"]').val(h);k["action-form"].find('input[name="selection.tabViewCode"]').val(n.tab);var C=F,w={};if(F.match(/::/)){var z=F.split("::");C=z[0],w=JSON.decode(z[1]||"{}")}w.type=w.type||"POST";var G=function(I){if(w.callback&&c.isFunction(w.callback)){w.callback(I)}if(w.trigger){u.trigger(w.trigger,[I])}};q.refreshTabViews=true;switch(C){case"blank":case"_blank":c.openWindow("about:blank",w.title||"window_open_"+h,w.width||-1,w.height||-1);k["action-form"].attr("target",w.title||"window_open_"+h);k["action-form"].attr("action",t);k["action-form"].attr("method",w.type);k["action-form"].submit();break;case"newWindow":case"_newWindow":k["action-form"].attr("target","_blank");k["action-form"].attr("action",t);k["action-form"].attr("method",w.type);k["action-form"].submit();break;case"dialog":var v=null;v=new c.dialog(c.extend({id:"-finder-dialog-"+(++b),html:true,cover:true,autoSize:true,rang:true,btnBar:false,iconTitle:false,onXclick:function(I){v.cancel();v.cleanDialog();l.trigger(i.data_send_event)},dgOnLoad:function(){k["action-form"].ajaxSubmit(c.extend({url:t},c.extend(w,{success:function(I){v.updateContent(I);G(I)}})))}},w));v.ShowDialog();break;case"update":if(!w.success){w.success=function(I){k.header.parent().updateHtml(I,false,G);l.trigger(i.data_send_event,[I])}}k["action-form"].ajaxSubmit(c.extend({url:t},w));break;case"replace":if(!w.success){w.success=function(I){k.header.parent().updateHtml(I,true,G);l.trigger(i.data_send_event,[I])}}k["action-form"].ajaxSubmit(c.extend({url:t},w));break;case"command":if(!w.success){w.success=function(I){G(I);l.trigger(i.data_send_event,[I])}}k["action-form"].ajaxSubmit(c.extend({url:t},w));break}return false})}if(k.search.exists()){k.search.find(".finder-search-select").maculadropmenu({fix:{x:-6,y:2}});k.keywords.find("li").click(function(u){var t=c(this).attr("key");k.search.find(".finder-search-select").find("label").text(c(this).text());k.search.find("input[name*=filters][name$=name]").val(t);k.search.find("div.searchWrapper").hideme().find("input,select,textarea").attr("disabled","disabled");k.search.find("div.searchWrapper."+t).showme().find("input,select,textarea").removeAttr("disabled");return false}).first().trigger("click");var j=k.search.find("input.finder-search-input");j.keypress(function(t){if(t.which==13){t.preventDefault();n.form=k.search;n.currentPage=1;k.search.trigger(i.data_send_event)}});k.search.find(".finder-search-btn").click(function(t){t.preventDefault();n.form=k.search;n.currentPage=1;k.search.trigger(i.data_send_event);return false})}var p=c("#side-r");if(k["filter-action"].exists()){var m=false;k["filter-action"].click(function(w,v){var u=c(this);var t=u.attr("url");if(u.hasClass("active")){p.trigger("hiderightpanel")}else{u.addClass("active");if(!m){p.macularightpanel({title:"高级筛选(搜索)",url:g(t,k["filter-action"].getContextPath()),onLoad:function(){p.find("#filter-submit-"+h).unbind("click").bind("click",function(x){k.filter=c("#finder-filter-"+h);n.form=k.filter;n.currentPage=1;k["filter-action"].trigger(i.data_send_event);c(this).blur();return false});if(v){p.find("#filter-submit-"+h).trigger("click")}},onShow:function(){k.search.parent().hideme()},onHide:function(){k.search.parent().showme();u.removeClass("active")}});m=true}p.trigger("showrightpanel")}c(this).blur();w.preventDefault();w.stopPropagation();return false})}p.trigger("hiderightpanel");if(k.header.exists()){k.header.find(".col-select-opt-inner").maculadropmenu({eventType:"click"});k.header.find(".col-select-opt-inner").hover(function(){c(this).find("img").css("visibility","visible")},function(){c(this).find("img").css("visibility","hidden")});k.header.find(".sellist").click(function(){var t=c(this).attr("checked");q.selectedItems=[];k.list.find("input[type=checkbox]").each(function(){c(this).attr("checked",t);c(this).trigger(i.row_selected_event)})})}if(k.tip.exists()){k.tip.bind(i.tip_update_event,function(w,v,t){if(t<2&&v!=i.selected_all_class){v="unselected"}c(this).children().each(function(){if(!c(this).hasClass(v)){c(this).hideme().parent().hideme().prev().addClass("hide")}});var u=c(this).find("."+v);if(u.exists()){u.html(u.html().replace(/<em>([\s\S]*?)<\/em>/ig,function(){return"<em>"+t+"</em>"})).showme().parent().showme().prev().removeClass("hide")}});k.tip.width(k.list.width()-2)}var l=c(document.body);a(l,h);if(k.pager.exists()){k.pager.maculapagination({code:h})}l.bind(i.data_arrive_event,function(u,t){q.dataTotal=t.totalElements;c("#content-head .finder-title .count2").text(q.dataTotal);if(t.content&&t.content.length){k.nodata.hideme();k.list.find("tbody:first").html(k["data-tmpl"].tmpl(t.content)).find("tr:odd").addClass("even").end().find("tr:even").addClass("odd").end().find("tr:first").addClass("first")}else{k.list.find("tbody:first").empty();k.nodata.showme()}l.trigger(i.row_all_unselected_event)}).bind(i.data_send_event,function(v,t){n=c.extend(n,t||{});if(n.form){n.form.find("input[name=rows]").val(n.pageSize);n.form.find("input[name=page]").val(n.currentPage);c.metadata.setType("attr","validate");var u=null;u=n.form.validate({focusInvalid:false,submitHandler:function(w){c(w).ajaxSubmit({url:g(o+n.form.attr("action")+"/"+n.tab,k.list.getContextPath()),dataType:"json",success:function(x){if(x.success){l.trigger(i.data_arrive_event,[x])}else{var y={};c(x.validateErrors).each(function(){y[this.element]=this.message});u.showErrors(y);x.exceptionMessage&&MessageBox.error(x.exceptionMessage,true)}}})}});n.form.submit()}else{mAjax({url:g(n.url,k.list.getContextPath()),type:"post",dataType:"json",data:{rows:n.pageSize,page:n.currentPage},success:function(w){if(w.success){l.trigger(i.data_arrive_event,[w])}else{w.exceptionMessage&&MessageBox.error(w.exceptionMessage,true)}}})}if(q.refreshTabViews&&k.packet.exists()){q.refreshTabViews=false;mAjax({url:g(n.tabs,k.list.getContextPath()),type:"post",dataType:"json",success:function(w){if(w.success){k.packet.find("li[tabViewCode]").each(function(){if(c(this).attr("tabViewCode")){c(this).find("em:first").text(w[c(this).attr("tabViewCode")])}})}else{w.exceptionMessage&&MessageBox.error(w.exceptionMessage,true)}}})}}).bind(i.row_all_selected_event,function(t){k.header.find(".sellist").attr("checked",true);if(q.dataTotal>0){q.selectedAllFlag=true;q.selectedItems=[];k.tip.trigger(i.tip_update_event,[i.selected_all_class,q.dataTotal]);r()}}).bind(i.row_all_unselected_event,function(t){k.header.find(".sellist").attr("checked",false);q.selectedAllFlag=false;q.selectedItems=[];k.tip.trigger(i.tip_update_event,[i.unselected_class,q.selectedItems.length]);r()}).bind(i.row_selected_event,function(v){var w=c(v.target).val(),u=c.inArray(w,q.selectedItems);if(c(v.target).attr("checked")){c(v.target).closest("tr").addClass("selected");if(u<0){q.selectedItems.push(w)}var t=true;k.list.find("input[type=checkbox].sel").each(function(){if(!c(this).attr("checked")){t=false;return false}});if(t){k.header.find(".sellist").attr("checked",true)}}else{c(v.target).closest("tr").removeClass("selected");if(u>=0){q.selectedItems.splice(u,1)}k.header.find(".sellist").attr("checked",false)}if(q.selectedItems.length==q.dataTotal||q.selectedAllFlag){k.tip.trigger(i.tip_update_event,[i.selected_all_class,q.dataTotal])}else{k.tip.trigger(i.tip_update_event,[i.selected_class,q.selectedItems.length])}r();c(v.target).blur()}).bind(i.row_choiced_event,function(u){var v=c(u.target).val(),t=c(u.target).closest("tr");t.parent().find("tr").removeClass("selected");t.addClass("selected");q.selectedItems=[v];c(u.target).blur()}).bind(i.item_detail_event,function(x){var u=c(x.target),w=u.closest("tr"),v=w.find(">td").size(),y=w.attr("item-id");if(c("#finder-detail-"+h).exists()){if(c("#finder-detail-"+h).attr("item-id")==y){if(w.hasClass("view-detail")){w.removeClass("view-detail");c("#finder-detail-"+h).remove()}else{}return}c("#finder-detail-"+h).prev("tr").removeClass("view-detail");c("#finder-detail-"+h).remove()}w.addClass("view-detail");var t=c("#finder-detail-tmpl-"+h).tmpl().attr("item-id",y).insertAfter(w);t.find(">td").attr("colspan",v);t.updateContents(g(n.detail,u.getContextPath()),{data:{item:y,tab:n.tab}},function(){k.list.parent().scrollTop(w.position().top);c("#finder-detail-content-"+h).width(k.list.width())})});c(window).resize(function(){setTimeout(function(){if(k.tip.exists()){k.tip.width(k.list.width())}if(c("#finder-detail-content-"+h).exists()){c("#finder-detail-content-"+h).width(k.list.width())}},500)});function r(){k.list.find("input[type=checkbox].sel").each(function(){var t=q.selectedAllFlag||c.inArray(c(this).val(),q.selectedItems)>=0;t?c(this).attr("checked",true).closest("tr").addClass("selected"):c(this).attr("checked",false).closest("tr").removeClass("selected")})}var f=null;k.list.parent().bind("scroll",function(){var t=c(this);if(f){clearTimeout(f)}f=setTimeout(function(){k.tip.css("margin-left",t.scrollLeft());k.header.css("margin-left",-t.scrollLeft());if(c("#finder-detail-content-"+h).exists()){c("#finder-detail-content-"+h).css("margin-left",t.scrollLeft())}},100)});if(n.queryOnLoad){if(k.search.exists()){n.form=k.search;l.trigger(i.data_send_event)}else{if(k["filter-action"].exists()){k["filter-action"].removeClass("active").trigger("click",[true])}else{l.trigger(i.data_send_event)}}}}})(jQuery);